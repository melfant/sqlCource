<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Основы SQL - презентация</title>
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- custom user theme -->
    <link rel="stylesheet" href="lib/css/bootstrap.css">
    <link rel="stylesheet" href="css/theme/tables.css">
    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>

<body>
    <div class="reveal">
        <div class="slides">

            <section>
                <h2>Презентация тут</h2>
                <img src="http://qrcoder.ru/code/?https%3A%2F%2Falexbolgov.github.io%2FSqlTrainingPresentation%2F&10&0" width="410" height="410"
                    border="0" title="QR код">
                <p>https://alexbolgov.github.io/SqlTrainingPresentation/</p>
            </section>


            <section>
                <section>
                    <h1>Вспомним,</h1>
                    <h3>Чему мы научились в дистанционной части</h3>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <p>Это мы умеем</p>
                    <pre><code>
select distinct 
    col1, col2 as column2, col3 column3, col4 [column 4], 
    case 
        when datediff(month, col5, current_timestamp) < 5 then 1
        else 0
    end as col5_modified, --Болгов, 2017-09-07
    len(col6) as len_col_6,
    col7 + '_' + isnull(col8, '') as col7_and_col8,
    cast('24' as int) as twenty_four,
    *
from table
where col1 <= 0 or col2 like '%pattern%' and col3 is null
order by col4 desc, col2 asc, col1</code></pre>
                    <h4>&darr;</h4>
                    <aside class=notes>
                        Что знакомого в запросе? Что происходит в каждом столбце?
                    </aside>
                </section>
                <section>
                    <p>Каков логический порядок выполнения запроса?</p>
                    <pre><code  class="sql">
select distinct 
    case 
        when datediff(month, col5, current_timestamp) < 5 then 1
        else 0
    end as col5_modified
from table
where col1 <= 0 or col2 like '%pattern%' and col3 is null
order by col5_modified desc</code></pre>
                    <pre class="fragment"><code>1. from table</code></pre>
                    <pre class="fragment"><code>2. where --какой порядок?</code></pre>
                    <pre class="fragment"><code>3. case ... as col5_modified</code></pre>
                    <pre class="fragment"><code>4. distinct</code></pre>
                    <pre class="fragment"><code>5. order by col5_modified desc</code></pre>
                    <pre class="fragment"><code>6. select</code></pre>
                </section>
            </section>
            <section>
                <h1>Запросы к нескольким таблицам</h1>
                <aside class=notes>
                    До сих пор мы работали только с единственной таблицей, но, данные, описывающие какую-то либо сущность, обычно разбиты на
                    несколько таблиц и хранятся в в них. Этот процесс известен как нормализация
                </aside>
            </section>
            <section>
                <p>Данные, описывающие объект, обычно хранятся в множестве таблиц</p>
                <br>
                <p>
                    <strong>Нормализация</strong> - это процесс преобразования данных, устраняющий:
                    <ul>
                        <li>Избыточность</li>
                        <li>Логические ошибки</li>
                        <li>Аномалии обновления</li>
                    </ul>
                </p>
                <aside class=notes>
                    Нормализация, как правило, нацелена на то, чтобы хранились только первичные факты (а не факты, выводимые из других)
                </aside>
            </section>
            <section>
                <section>
                    <p>Попробуем нормализовать таблицу</p>
                    <table class="table-small">
                        <tbody>
                            <tr>
                                <th>FullName</th>
                                <td>Болгов Александр Викторович</td>
                            </tr>
                            <tr>
                                <th>BirthDate</th>
                                <td>1988-05-30</td>
                            </tr>
                            <tr>
                                <th>HireDate</th>
                                <td>2014-04-01</td>
                            </tr>
                            <tr>
                                <th>HireAge</th>
                                <td>24</td>
                            </tr>
                            <tr>
                                <th>Department</th>
                                <td>Казначейство/ОБАС ALM</td>
                            </tr>
                            <tr>
                                <th>Salary</th>
                                <td>890</td>
                            </tr>
                            <tr>
                                <th>BossFullName</th>
                                <td>Нейштадт Игорь Анатольевич</td>
                            </tr>
                            <tr>
                                <th>SalaryDiffWithBoss</th>
                                <td>1000</td>
                            </tr>
                        </tbody>
                    </table>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <h4>Идеи</h4>
                    <ul>
                        <li class=fragment>Разбить ФИО на три поля</li>
                        <li class=fragment>Не хранить HireAge</li>
                        <li class=fragment>Нужна таблица департаментов</li>
                        <li class=fragment>Сотрудник должен иметь id</li>
                        <li class=fragment>Босс должен быть указан ссылкой</li>
                        <li class=fragment>Не хранить разницу зарплат</li>
                    </ul>
                    <h4 class=fragment>&darr;</h4>
                </section>
                <section>
                    <div class="row">
                        <div class="col-xs-6">
                            <table class="table-small">
                                <tr>
                                    <td><span class="fragment">PK</span></td>
                                    <th>EmployeeId</th>
                                    <td>1</td>
                                    <td>2</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <th>FirstName</th>
                                    <td>Александр</td>
                                    <td>Игорь</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <th>MiddleName</th>
                                    <td>Викторович</td>
                                    <td>Анатольевич</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <th>LastName</th>
                                    <td>Болгов</td>
                                    <td>Нейштадт</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <th>HireDate</th>
                                    <td>2014-04-01</td>
                                    <td>NULL</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <th>BirthDate</th>
                                    <td>1988-05-30</td>
                                    <td>NULL</td>
                                </tr>
                                <tr>
                                    <td><span class="fragment">FK</span></td>
                                    <th>DepartmentId</th>
                                    <td>101</td>
                                    <td>101</td>
                                </tr>
                                <tr>
                                    <td><span class="fragment">FK</span></td>
                                    <th>BoossId</th>
                                    <td>2</td>
                                    <td>NULL</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <th>Salary</th>
                                    <td>890</td>
                                    <td>1890</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-xs-6">
                            <table class="table-small">
                                <tr>
                                    <td><span class="fragment">PK</span></td>
                                    <th>DepartmentId</th>
                                    <td>101</td>
                                </tr>
                                <tr>
                                    <td><span class="fragment">UK</span></td>
                                    <th>DepartmentName</th>
                                    <td>ОБАС ALM</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </section>
                <aside class="notes">
                    Давайте рассмотрим таблицу, которую мог создать один из менеджеров. Какие вы могли бы сделать предложения по улучшению структуры
                    таблицы? 5 Минут, работаем в группах, каждая группа делаем доклад 2 минуты
                </aside>
            </section>
            <section>
                <p><strong>PK</strong> - primary key, столбец (или комбинация), которое уникальным образом определяет запись
                    в таблице. Бизнес-смысла нет.</p>
                <p class=fragment><strong>UK</strong> - Unique key, уникальная комбинация столбцов. Как правило, имеет бизнес-смысл.</p>
                <p class=fragment><strong>FK</strong> - Foreign key, ограничение, гарантирующее, что значения в столбце будут только из множества
                    значений определенного PK</p>
            </section>
            <section>
                <section>
                    <h1>Учебная БД</h1>
                    <h1>&darr;</h1>
                </section>
                <section data-background-image="pictures/dw-schema.png" data-background-size="100%"></section>

            </section>
            <section>
                <h3>Соединение таблиц</h3>
                <p>Для соединения двух и более таблиц используется оператор
                    <mark>JOIN</mark>
                </p>
                <p class=fragment>* Похож на ВПР (vlookup)</p>
            </section>
            <section>
                <div class="row">
                    <div class="col-xs-6">
                        <table class="table-small">
                            <caption>EnglishNumbers</caption>
                            <tr>
                                <td>PK</td>
                                <th>NumberId</th>
                            </tr>
                            <tr>
                                <td></td>
                                <th>NumberName</th>
                            </tr>
                        </table>
                        <br>
                        <table class="table-small">
                            <caption>FrenchNumbers</caption>
                            <tr>
                                <td>PK</td>
                                <th>NumberId</th>
                            </tr>
                            <tr>
                                <td></td>
                                <th>NumberName</th>
                            </tr>
                        </table>
                    </div>
                    <div class="col-xs-6">
                        <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
join FrenchNumbers f on 
    e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                    </div>
                </div>
            </section>
            <section>
                <section>
                    <h3>Как работает JOIN?</h3>
                    <div class="row">
                        <div class="col-xs-6">
                            <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
join FrenchNumbers f on 
    e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                            <img class="invert" src="pictures/joinmapping-inner-join.png" alt="join mapping">

                        </div>
                        <div class="col-xs-6">
                            <p>Для каждой пары строк вычисляется предикат соединения</p>
                            <p>Если предикат
                                <mark>TRUE</mark> - пара строк попадает в выборку</p>

                        </div>
                    </div>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <p>INNER JOIN == JOIN</p>
                    <img class="invert" src="pictures/join-schema.png" alt="join-schema">
                </section>
            </section>
            <section>
                <h4>Порядок выполнения запроса</h4>

                <div class="row">
                    <div class="col-xs-6">
                        <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
join FrenchNumbers f on 
    e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                    </div>
                    <div class="col-xs-6">
                        <pre class="fragment"><code>1. from EnglishNumbers as e</code></pre>
                        <pre class="fragment"><code>2. join FrenchNumbers f on ...</code></pre>
                        <pre class="fragment"><code>3. where ...</code></pre>
                        <pre class="fragment"><code>4. evaluate columns</code></pre>
                        <pre class="fragment"><code>5. select</code></pre>
                    </div>
                </div>
            </section>
            <section>
                <h3>Вопрос</h3>
                <p class="fragment">В чем разница?</p>
                <div class="row fragment">
                    <div class="col-xs-6">
                        <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
join FrenchNumbers f 
    on e.NumberId = 
        f.NumberId and
    e.NumberId > 3</code></pre>
                    </div>
                    <div class="col-xs-6">
                        <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
join FrenchNumbers f 
    on e.NumberId = 
        f.NumberId and
where e.NumberId > 3</code></pre>
                    </div>
                </div>
            </section>
            <section>
                <p>В одном запросе можно присоединять несколько таблиц (и даже ту же самую таблицу)</p>
                <pre><code>select *
from table1 t1
join table2 t2 on t1.id = t2.id
join table3 t3 on t3.id = t2.id
join table1 t1_par on t1.parent_id = t1_par.id
....</code></pre>
                <p class="fragment">Операции соединения логически выполняются слева-направо и в объединении участвует всегда 2 множества. Результирующее
                    множество является входящим слева для следующей операции соединения.
                </p>
            </section>
            <section>
                <section>
                    <h1>Немного практики</h1>
                    <h1>&darr;</h1>
                </section>
                <section>
                    <h3>Join - Задача 1</h3>
                    <p>Напишите запрос, выбирающий для каждого продукта\товара (таблица DimProduct), его имя на английском языке
                        (EnglishProductName) и название под-категории на Английском языке(таблица DimSubCategory, столбец
                        EnglishProductSubcategoryName). Необходимо выбрать только те продукты, у которых определена под-категория.
                    </p>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <h3>Join - Задача 2</h3>
                    <p>Модифицируйте запрос из предыдущей задачи таким образом, чтобы выбирались только продукты\товары красного
                        цвета.
                    </p>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <h3>Join - Задача 3</h3>
                    <p>Добавьте к предыдущему запросу еще название Категории продукта на английском языке.</p>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <h3>Join - Задача 4*</h3>
                    <p>Напишите запрос, выбирающий id сотрудников, у которых первая буква имени совпадает с первой буковй имени
                        начальника
                    </p>
                </section>
            </section>
            <section>
                <p>Как оставить строку Two - 2 из EnglishNumbers в выборке?</p>
                <div class="row">
                    <div class="col-xs-6">
                        <img class="invert fragment fade-out" data-fragment-index="0" src="pictures/joinmapping-left-join-empty.png" alt="join mapping">
                        <img style="position:absolute;left:12px;" class="invert fragment fade-in" data-fragment-index="0" src="pictures/joinmapping-left-join.png"
                            alt="join mapping"></div>
                    <div class="col-xs-6">
                        <table class="table-small">
                            <caption>EnglishNumbers</caption>
                            <tr>
                                <td>PK</td>
                                <th>NumberId</th>
                            </tr>
                            <tr>
                                <td></td>
                                <th>NumberName</th>
                            </tr>
                        </table>
                        <br>
                        <table class="table-small">
                            <caption>FrenchNumbers</caption>
                            <tr>
                                <td>PK</td>
                                <th>NumberId</th>
                            </tr>
                            <tr>
                                <td></td>
                                <th>NumberName</th>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col fragment" data-fragment-index="0">
                        <p>Idea!!</p>
                        <h2>LEFT JOIN</h2>
                    </div>
                </div>


            </section>
            <section>
                <h3>left join</h3>
                <div class="row">
                    <div class="col-xs-6">
                        <table class="table-small">
                            <caption>EnglishNumbers</caption>
                            <tr>
                                <td>PK</td>
                                <th>NumberId</th>
                            </tr>
                            <tr>
                                <td></td>
                                <th>NumberName</th>
                            </tr>
                        </table>
                        <br>
                        <table class="table-small">
                            <caption>FrenchNumbers</caption>
                            <tr>
                                <td>PK</td>
                                <th>NumberId</th>
                            </tr>
                            <tr>
                                <td></td>
                                <th>NumberName</th>
                            </tr>
                        </table>
                    </div>
                    <div class="col-xs-6">
                        <pre><code data-noescape>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
<mark>left</mark> join FrenchNumbers f on 
    e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <section>
                    <h3>Как работает LEFT JOIN?</h3>
                    <div class="row">
                        <div class="col-xs-6">
                            <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
join FrenchNumbers f on 
    e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                            <img class="invert" src="pictures/joinmapping-left-join.png" alt="join mapping"></div>
                        <div class="col-xs-6">
                            <p>Для каждой пары строк вычисляется предикат соединения</p>
                            <p>Если предикат
                                <mark>TRUE</mark> - пара строк попадает в выборку</p>
                            <mark>иначе,</mark>
                            строка Левой таблицы попадает в выборку, а вместо правой - подставляются NULL
                        </div>
                    </div>
                    <h4>&darr;</h4>
                </section>
                <section>
                    <p>LEFT OUTER JOIN == LEFT JOIN</p>
                    <img class="invert" src="pictures/left-join-schema.png" alt="left-join-schema">
                </section>
            </section>
            <section>
                <section>
                    <h3>Вопрос</h3>
                    <p class="fragment">В чем разница?</p>
                    <div class="row fragment">
                        <div class="col-xs-6">
                            <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
left join FrenchNumbers f 
    on e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                        </div>
                        <div class="col-xs-6">
                            <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from FrenchNumbers f
left join EnglishNumbers as e
    on e.NumberId = 
        f.NumberId
where f.NumberId > 0</code></pre>
                        </div>
                    </div>
                </section>
                <section>
                    <h3>Вопрос</h3>
                    <p class="fragment">В чем разница?</p>
                    <div class="row fragment">
                        <div class="col-xs-6">
                            <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
left join FrenchNumbers f 
    on e.NumberId = 
        f.NumberId and
    e.NumberId > 3</code></pre>
                        </div>
                        <div class="col-xs-6">
                            <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
left join FrenchNumbers f 
    on e.NumberId = 
        f.NumberId and
where e.NumberId > 3</code></pre>
                        </div>
                    </div>
                </section>
            </section>
            <section>
                <h4>Порядок выполнения запроса</h4>
                <div class="row">
                    <div class="col-xs-6">
                        <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
left join FrenchNumbers f 
    on e.NumberId = 
        f.NumberId
where e.NumberId > 0</code></pre>
                    </div>
                    <div class="col-xs-6">
                        <pre class="fragment"><code>1. from EnglishNumbers as e</code></pre>
                        <pre class="fragment"><code>2. left join FrenchNumbers f 
    on ...</code></pre>
                        <pre class="fragment"><code>3. where ...</code></pre>
                        <pre class="fragment"><code>4. evaluate columns</code></pre>
                        <pre class="fragment"><code>5. select</code></pre>
                    </div>
                </div>
            </section>
            <section>
                <p>join и left join можно комбинировать в одном запросе</p>
                <pre><code>select *
from table1 t1
left join table2 t2 on t1.id = t2.id
join table3 t3 on t3.id = t2.id
left join table1 t1_par on t1.parent_id = t1_par.id
....</code></pre>
                <p class="fragment">join-инструкции выполняются последовательно!</p>
            </section>
            <section>
                <section>
                    <h1>Немного практики</h1>
                    <h1>&darr;</h1>
                </section>
                <section>
                    <h3>Left JOIN - Задача 1</h3>
                    <p>Для каждого продукта (DimProduct) вывести его название на английском языке (EnglishProductName) и, если есть, название под-категории на английском языке (EnglishProductSubcategoryName)</p>
                    <h1>&darr;</h1>
                </section>
                <section>
                    <h3>Left JOIN - Задача 2</h3>
                    <h1>&darr;</h1>
                </section>
                <section>
                    <h3>Left JOIN - Задача 3</h3>
                    <p></p>
                    <h1>&darr;</h1>
                </section>
                <section>
                    <h3>Left JOIN - Задача 4*</h3>
                    <h1>&darr;</h1>
                </section>
            </section>

            <section>
                <section>
                    <h3>RIGHT JOIN</h3>
                    <p>это тоже самое, что и LEFT JOIN, где таблицы поменяли местами</p>
                </section>
                <section>
                    <h4>Как переписать запрос с использованием right join?</h4>
                    <div class="row">
                        <div class="col-xs-6">
                            <pre><code>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from FrenchNumbers f 
left join EnglishNumbers as e
    on e.NumberId = 
        f.NumberId</code></pre>
                        </div>
                        <div class="col-xs-6 fragment">
                            <pre><code data-noescape>select 
    e.NumberName as EngNumber,
    f.NumberName as FreNumber,
    e.*,
    *
from EnglishNumbers as e
<mark>right</mark> join FrenchNumbers f
    on e.NumberId = 
        f.NumberId</code></pre>
                        </div>
                    </div>
                </section>
                <section>
                    <img class="invert" src="pictures/joinmapping-right-join.png" alt="right-join">
                </section>
            </section>

            <section>
                <section>
                    <div class="row">
                        <div class="col-xs-12">
                            <p>Как оставить строки правой таблицы и строки левой таблицы в выборке?</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-6">
                            <img class="invert" src="pictures/joinmapping-full-join.png" alt="join mapping">
                        </div>
                        <div class="col-xs-6">
                            <table class="table-small">
                                <caption>EnglishNumbers</caption>
                                <tr>
                                    <td>PK</td>
                                    <th>NumberId</th>
                                </tr>
                                <tr>
                                    <td></td>
                                    <th>NumberName</th>
                                </tr>
                            </table>
                            <br>
                            <table class="table-small">
                                <caption>FrenchNumbers</caption>
                                <tr>
                                    <td>PK</td>
                                    <th>NumberId</th>
                                </tr>
                                <tr>
                                    <td></td>
                                    <th>NumberName</th>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="row fragment " data-fragment-index="0">
                        <div class="col">
                            <p>Idea!!</p>
                            <h2>FULL JOIN</h2>
                        </div>
                    </div>
                </section>
                <section>
                    <p>FULL OUTER JOIN == FULL JOIN</p>
                    <img class="invert" src="pictures/full-join-schema.png" alt="left-join-schema">
                </section>
            </section>

            <section>
                <p>А как получить декартово произведение?</p>
                <div class="row">
                    <div class="col-xs-6">
                        <img class="invert" src="pictures/cross-join-schema.png" alt="cross join">
                    </div>
                    <div class="col-xs-6">
                        <pre class="fragment"><code>join ... on 1=1</code></pre>
                        <p class="fragment">CROSS JOIN !!!</p>
                        <pre class="fragment"><code>select *
from table1
cross join table2
...</code></pre>
                    </div>
                </div>


            </section>
            <section>
                <h3>JOIN - итоги</h3>
                <ol>
                    <li class="fragment">Внутренний (inner) join</li>
                    <li class="fragment">Внешний</li>
                    <ol>
                        <li class="fragment">left (outer) join</li>
                        <li class="fragment">full (outer) join</li>
                        <li class="fragment">right (outer) join</li>
                    </ol>
                    <li class="fragment">Декартово cross join</li>
                </ol>
            </section>

            <section>
                <h1>ПОДЗАПРОСЫ</h1>
            </section>
            <section>
                <section>
                    <h3>Самостоятельные скалярные подзапросы</h3>
                    <p>Запрос, возвращающий одно значение, может быть использован везде, где ожидается скалярное выражение</p>
                    <div class="row">
                        <div class="col-xs-5 fragment">
                            <pre><code>select CurrencyAlternateKey
from DimCurrency
where CurrencyAlternateKey 
    = 'USD'
-- 100

select *
from FactInternetSales
where CurrencyKey = 100</code></pre>
                        </div>
                        <div class="col-xs-7 fragment">
                            <pre><code>select *
from FactInternetSales
where CurrencyKey =
(
    select ccy.CurrencyKey
    from DimCurrency ccy
    where ccy.CurrencyAlternateKey 
        = 'USD'
)</code></pre>
                        </div>
                    </div>
                </section>
                <section>
                    <p>Если запрос вернет больше одного значения - ошибка</p>
                    <pre><code>select *
from FactInternetSales
where CurrencyKey = 
(
    select ccy.CurrencyKey
    from DimCurrency ccy
    where ccy.CurrencyAlternateKey > 'A'
)</code></pre>
                    <pre class="fragment sql-exception">Msg 512, Level 16, State 1, Line 1
Subquery returned more than 1 value</pre>
                </section>
                <section>
                    <p>Если запрос вернет пустоту, то в выражение подставится NULL</p>
                    <pre><code>select *
from FactInternetSales
where 
(
    select ccy.CurrencyKey
    from DimCurrency ccy
    where ccy.CurrencyAlternateKey = 'CCY'
) is null</code></pre>
                </section>
            </section>
            <section>
                <section>
                    <h3>Самостоятельный подзапрос, возвращающий столбец</h3>
                    <p>используется в предикате, когда хочется проверить, принадлежит ли значение списку</p>
                    <div class="row">
                        <div class="col-xs-6">
                            <pre><code>select *
from FactInternetSales
where CurrencyKey in ( 19, 100 )
                            </code></pre>
                            <pre class=fragment data-fragment-index="1"><code>select *
from FactInternetSales
where CurrencyKey not in 
    ( 19, 100 )</code></pre>
                        </div>
                        <div class="col-xs-6 fragment" data-fragment-index="0">
                            <pre><code>select * 
from FactInternetSales 
where CurrencyKey in 
( 
    select ccy.CurrencyKey 
    from DimCurrency ccy 
    where CurrencyAlternateKey 
        in ('USD', 'CAD') 
)</code></pre>
                        </div>
                    </div>
                </section>
                <section>
                    <h3>NULL vs IN</h3>
                    <p class=fragment>При выполнении операции
                        <mark>in</mark> происходит сравнение элемента слева с каждым элементом из подзапроса через равенство (=),
                        и
                        <mark>NULL</mark>
                        ведет себя как при операции =</p>
                </section>
            </section>
            <section>
                <section>
                    <h3>Закрепим знания</h3>
                    <p>&darr;</p>
                </section>
                <section>
                    <h4>Задача 1 - подзапрос</h4>
                    <p>Написать запрос, выбирающий все продажи через реселлера (все строки таблицы FactResellerSales), у которых
                        дата заказа приходится на второй фискальный семестр 2010 года (DimDate)</p>
                </section>
                <section>
                    <h4>Задача 2 - подзапрос</h4>
                    <p>Написать запрос, выбирающий все заказы через реселлера, скидка по которым была свыше 10% (0.1). Необходимо
                        вывести ID заказа и дополнительный столбец SaleColor, который имеет значение 'R', если товар красного
                        цвета, или 'O' в противном случае.</p>
                </section>
                <section>
                    <h4>Задача 3* - подзапрос</h4>
                    <p>Написать запрос, возвращающий список ID сотрудников (DimEmployee), находящихся на втором уровне подчинения.
                        Например, Греф->Морозов->Лякин. Вывести Лякина.</p>
                </section>
            </section>

            <section>

                <h4>Коррелированные подзапросы</h4>
                <p>это такие подзапросы, в которых есть зависимость от внешнего запроса</p>
                <p></p>

            </section>
            <section>

                <p class=fragment>Скалярный коррелированный подзапрос</p>
                <pre><code data-noescape>select top 10
    'CurrencyName is ' + (
        select ccy.CurrencyName
        from DimCurrency ccy
        where <mark>sls.CurrencyKey</mark> = ccy.CurrencyKey
    ) as CurrencyName,
        *
from FactInternetSales sls</code></pre>
                <p class="fragment">Возвращает скаляр (одно значение)</p>
                <p class="fragment">Зависит от внешнего запроса</p>
                <p class="fragment"><i>Те же правила, что и для скалярного самостоятельного подзапроса</i></p>
            </section>

            <section>

                <h4>Коррелированный подзапрос, возвращающий столбец</h4>
                <pre><code data-noescape>select *
from DimProduct p
where p.ProductKey in 
(
    select sls.ProductKey
    from FactInternetSales sls
    where sls.ProductKey = <mark>p.ProductKey</mark> and 
        sls.UnitPrice > <mark>p.StandardCost</mark>
)</code></pre>
                <p class="fragment">Все также, как и самостоятельном подзапросе, возвращающем столбец, за исключением зависимости от внешнего
                    запроса
                </p>
            </section>

            <section>

                <h4>Оператор exists</h4>
                <p class=fragment>используется в составе предиката, чтобы проверить, есть ли строки в подзапросе или нет</p>
                <pre class=fragment><code data-noescape>select *
from DimProduct p
where exists
(
    select *
    from FactInternetSales sls
    where sls.ProductKey = <mark>p.ProductKey</mark> and 
        sls.UnitPrice > <mark>p.StandardCost</mark>
)</code></pre>
            </section>

            <section>
                <section>
                    <h3>Порешаем задачи</h3>
                    <p>&darr;</p>
                </section>
                <section>
                    <h4>Задача 1 - корелированный подзапрос</h4>
                    <p>Для каждого реселлера (DimReseller) вывести его ID и город (City), в котором он находится. Задачу решить
                        с помощью подзапроса.</p>
                </section>
                <section>
                    <h4>Задача 2 - корелированный подзапрос</h4>
                    <p>Написать запрос, выбирающий сотрудников (все столбцы), для которых была установлена квота в 2010 фискальном
                        году
                    </p>
                </section>
                <section>
                    <h4>Задача 3 - корелированный подзапрос</h4>
                    <p>Вывести все ID интернет-продаж, причиной продажи которых не был Маркетинг</p>
                </section>
                <section>
                    <h4>Задача 4</h4>
                    <p>Для каждого сотрудника вывести его ID, а также ID другого сотрудника, который будет праздновать день
                        рождения не раньше него. Если таких сотрудников несолько, вывести минимальный ID</p>
                </section>
            </section>

            <section>
                <h3>Табличные выражения</h3>
            </section>
            <section>
                <h4>Производные таблицы</h4>
                <p>Что такое табличное выражение?<br>Рассмотрим пример</p>
                <pre><code>select *
from 
(
    select *
    from DimProduct p
    where p.Color = 'Blue'
) as blueProducts</code></pre>
                <ul>
                    <li class="fragment">Все столбцы табл. выражения должны иметь уникальные имена</li>
                    <li class="fragment">Табличное выражение не может содержать ORDER BY без TOP</li>
                </ul>
            </section>
            <section>
                <h4>Обобщенные табличные выражения</h4>
                <p>Common Table Expressions (CTE)</p>
                <pre><code>with blueProducts as (
    select *
    from DimProduct p
    where p.Color = 'Blue'
)
select *
from blueProducts</code></pre>
                <p class="fragment">* К CTE можно обращаться несколько раз в одном запросе</p>
                <p class="fragment">* Внутри CTE можно обращатся к предыдущему CTE</p>
            </section>

            <!--section>
                <section>
                    <h3>Повторим табличные выражения</h3>
                    <p>&darr;</p>
                </section>
                <section>Задача 1 - табличные выражения</section>
                <section>Задача 2 - табличные выражения</section>
                <section>Задача 3 - табличные выражения</section>
                <section>Задача 4* - табличные выражения</section>
            </section-->

            <section>
                <h2>ГРУППИРОВАННЫЕ ЗАПРОСЫ</h2>
            </section>
            <section>
                <h4>Кому они нужны?</h4>
                <p class="fragment">Группированные запросы нужны для подсчета аггрегированных мер (сумм, средних и т.д.) в разрезе некоторых
                    групп
                </p>
                <pre class="fragment"><code class="sql">select count(*)
from FactResellerSales

select CurrencyKey, count(*)
from FactResellerSales
group by CurrencyKey</code></pre>
                <p class=fragment>Запрос становится группированным, если есть групповая функции или GROUP BY</p>
            </section>
            <section>
                <h4>Какие есть групповые функции?</h4>
                <pre><code class="sql">select count(*), -- количество строк в группе 
    count(column), -- количество непустых
    count(distinct column), -- количество уникальных
    sum(column), -- сумма
    max(column), -- максимум
    min(column), -- минимум
    avg(column) -- среднее
from tbl
group by other_column</code></pre>
                <p class="fragment">Групповые функции игнорируют NULL</p>
            </section>

            <section>
                <section>
                    <h3>Попробуем написать групповой запрос</h3>
                    <p>&darr;</p>
                </section>
                <section>
                    <h4>Задача 1 - group by</h4>
                    <p>Написать запрос, возвращающий сколько существует продуктов каждого цвета. Столбец с количеством продуктов
                        назвать cnt </p>
                </section>
                <section>
                    <h4>Задача 2 - group by</h4>
                    <p>Написать запрос, возвращающий название категории продуктов на англ. (EnglishProductCategoryName) и количество
                        продуктов в этой категории, таких, что средняя цена товара в категории (ListPrice) больше 100 долларов.
                        Рассматривать только продукты черного цвета.
                    </p>
                </section>
                <section>
                    <h4>Задача 3 - group by</h4>
                    <p>Вывести 30% самых дорогих под-категорий продуктов (EnglishProductSubcategoryName) и их среднюю стоимость
                        (AveragePrice). для сравнения использовать среднюю стандартную стоимость.</p>
                </section>
                <section>
                    <h4>Задача 4 - group by</h4>
                    <p>Для каждого продукта вывести его ID и сумму всех продаж за все время через интернет (столбец назвать TotalInternetSales)
                        и сумму всех продаж за все время через реселлера (назвать TotalResellerSales), а также полную сумму
                        продаж (назвать TotalSales). Если продаж не было, во все объемы показывать 0.</p>
                </section>
            </section>

            <section>
                <h4>having</h4>
                <p>используется для фильтрации на групповом уровне</p>
                <pre class="fragment"><code class="sql">select OrderDateKey, count(*) as cnt
from FactResellerSales
group by OrderDateKey
having count(*) > 3000</code></pre>
                <p class="fragment">having применяется к группе, а не к строке</p>
                <p class="fragment">после having можно использовать только групповые столбцы и функции</p>
            </section>

            <section>
                <h4>Порядок исполнения запроса</h4>
                <div class="row">
                    <div class="col-xs-6">
                        <pre><code class="sql">select 
    OrderDateKey, 
    count(*) as cnt
from FactResellerSales
where UnitPrice > 10
group by OrderDateKey
having count(*) > 3000</code></pre>
                    </div>
                    <div class="col-xs-6">
                        <pre class="fragment"><code>1. from ...</code></pre>
                        <pre class="fragment"><code>2. where ...</code></pre>
                        <pre class="fragment"><code>3. group by ...</code></pre>
                        <pre class="fragment"><code>4. having ...</code></pre>
                        <pre class="fragment"><code>5. evaluate columns ...</code></pre>
                        <pre class="fragment"><code>6. select ...</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <h1>Конец!</h1>
            </section>

        </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
        // More info about config & dependencies:
        // - https://github.com/hakimel/reveal.js#configuration
        // - https://github.com/hakimel/reveal.js#dependencies
        Reveal.initialize({
            dependencies: [
                { src: 'plugin/markdown/marked.js' },
                { src: 'plugin/markdown/markdown.js' },
                { src: 'plugin/notes/notes.js', async: true },
                { src: 'plugin/highlight/highlight.js', async: true, callback: function () { hljs.initHighlightingOnLoad(); } }
            ]
        });
        Reveal.configure({ slideNumber: true });
    </script>
</body>

</html>